# Google Cloud Pub/Sub OrderedKey æŒ™å‹•æ¤œè¨¼

Google Cloud Pub/Subã®OrderedKeyæ©Ÿèƒ½ã®å®Ÿéš›ã®æŒ™å‹•ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®Dartãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

## æ¤œè¨¼ç›®çš„

OrderedKeyã‚’ä½¿ç”¨ã—ãŸå ´åˆã®ä»¥ä¸‹ã®æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã™ï¼š

**æ¤œè¨¼ã—ãŸã„ä»®èª¬:**
- OrderedKeyã¯ã€Œé…ä¿¡é †åºã€ã‚’ä¿è¨¼ã™ã‚‹
- ã—ã‹ã—ã€ACKå®Œäº†å‰ã«æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒpullå¯èƒ½ã‹ã©ã†ã‹ã¯ä¸æ˜

**å…·ä½“çš„ãªã‚·ãƒŠãƒªã‚ª:**

ä»¥ä¸‹ã®ã©ã¡ã‚‰ã«ãªã‚‹ã®ã‹ä¸æ˜ãªã®ã§æ¤œè¨¼ã™ã‚‹

```
åŒã˜OrderedKeyã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Aã€Bã‚’é€ä¿¡ã—ãŸå ´åˆï¼š

ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆå³å¯†ãªé †åºä¿è¨¼ï¼‰:
1. Subscriber1ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Aã‚’pull
2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Bã¯ä»–ã®SubscriberãŒpullä¸å¯ï¼ˆAã®ACKå¾…ã¡ï¼‰
3. Subscriber1ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Aã‚’ACK
4. Subscriber2ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Bã‚’pullå¯èƒ½ã«ãªã‚‹

ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼ˆé…ä¿¡é †åºã®ã¿ä¿è¨¼ï¼‰:
1. Subscriber1ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Aã‚’pull
2. Subscriber2ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸Bã‚’pullå¯èƒ½ï¼ˆAã®ACKå‰ã§ã‚‚ï¼‰
3. å„SubscriberãŒç‹¬ç«‹ã—ã¦ACK
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
poc-pubsub-orderedkey/
â”œâ”€â”€ bin/
â”‚   â”œâ”€â”€ publisher.dart       # OrderedKeyä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
â”‚   â””â”€â”€ subscriber.dart      # ä¸¦åˆ—Subscriberï¼ˆã‚¹ãƒªãƒ¼ãƒ—â†’ACKï¼‰
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ config.dart         # GCPè¨­å®š
â”œâ”€â”€ pubspec.yaml
â””â”€â”€ README.md
```

## å‰ææ¡ä»¶

1. Google Cloud Projectã®ä½œæˆ
2. Pub/Sub APIã®æœ‰åŠ¹åŒ–
3. Service Accountã®ä½œæˆã¨èªè¨¼æƒ…å ±ã®è¨­å®š
4. Dart SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. GCPãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’è¨­å®š
export PROJECT_ID="your-project-id"

# Topicã®ä½œæˆï¼ˆOrderedKeyæœ‰åŠ¹ï¼‰
gcloud pubsub topics create test-ordered-topic

# Subscriptionã®ä½œæˆï¼ˆOrderedKeyæœ‰åŠ¹ï¼‰
gcloud pubsub subscriptions create test-ordered-subscription \
  --topic=test-ordered-topic \
  --enable-message-ordering
```

### 2. èªè¨¼è¨­å®š

```bash
# Application Default Credentials (ADC) ã‚’è¨­å®š
gcloud auth application-default login

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š
gcloud config set project YOUR_PROJECT_ID
```

### 3. ç’°å¢ƒå¤‰æ•°è¨­å®š

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š

```
PROJECT_ID=your-project-id
TOPIC_NAME=test-ordered-topic
SUBSCRIPTION_NAME=test-ordered-subscription
```

### 4. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
dart pub get
```

## å®Ÿè¡Œæ–¹æ³•

### 1. Publisherã®å®Ÿè¡Œ

```bash
dart run bin/publisher.dart
```

**å…¨15å€‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åŒä¸€OrderedKeyï¼ˆ'test-key-1'ï¼‰ã§é€ä¿¡**ã—ã€3ä¸¦åˆ—Subscriberã®ç«¶åˆçŠ¶æ³ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

### 2. Subscriberã®å®Ÿè¡Œ

```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆ3 subscribers, maxMessages=3ï¼‰
dart run bin/subscriber.dart

# ã‚«ã‚¹ã‚¿ãƒ è¨­å®š
dart run bin/subscriber.dart --subscribers=5 --max-messages=10

# çŸ­ç¸®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
dart run bin/subscriber.dart -s 2 -m 1

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
dart run bin/subscriber.dart --help
```

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- `--subscribers` / `-s`: ä¸¦åˆ—Subscriberæ•°ï¼ˆ1-20ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
- `--max-messages` / `-m`: 1å›ã®pullã§å–å¾—ã™ã‚‹æœ€å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ï¼ˆ1-100ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
- `--help` / `-h`: ãƒ˜ãƒ«ãƒ—è¡¨ç¤º

#### å‹•ä½œå†…å®¹
æŒ‡å®šã•ã‚ŒãŸæ•°ã®ä¸¦åˆ—SubscriberãŒèµ·å‹•ã—ã€ä»¥ä¸‹ã®å‹•ä½œã‚’è¡Œã„ã¾ã™ï¼š
- **ãƒãƒƒãƒå‡¦ç†**: æŒ‡å®šã•ã‚ŒãŸ`maxMessages`ã§è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åŒæ™‚pull
- å—ä¿¡ã—ãŸå…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é †æ¬¡å‡¦ç†ã—ã¦ã¾ã¨ã‚ã¦ACK
- æŒ‡å®šã•ã‚ŒãŸæ™‚é–“ã®ã‚¹ãƒªãƒ¼ãƒ—ï¼ˆå‡¦ç†æ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
- **è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›**:
  - ğŸ“¦ BATCH PULLED: ãƒãƒƒãƒå—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°è¡¨ç¤º
  - ğŸ”„ Processing: å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†çŠ¶æ³ï¼ˆN/Må½¢å¼ï¼‰
  - âœ… Processed: å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†å®Œäº†
  - ğŸ¯ BATCH ACKED: ãƒãƒƒãƒå…¨ä½“ã®ACKå®Œäº†
  - â±ï¸ ãƒãƒƒãƒå‡¦ç†æ™‚é–“ã®è¨ˆæ¸¬
  - â•â•â• åŒºåˆ‡ã‚Šç·šã§å„ãƒãƒƒãƒã‚’æ˜ç¢ºåŒ–

## ğŸ“Š æ¤œè¨¼çµæœ

### ğŸ”¬ ãƒ†ã‚¹ãƒˆç’°å¢ƒ
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°**: 15å€‹
- **Subscriber**: 3ä¸¦åˆ—
- **å‡¦ç†æ™‚é–“**: 0-5ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ãƒªãƒ¼ãƒ—

### âœ… æ¤œè¨¼çµæœã¾ã¨ã‚

| ã‚·ãƒŠãƒªã‚ª      | OrderingKey                                                          | å‡¦ç†æ–¹å¼       | çµæœ                                                                                                                   |
| ------------- | -------------------------------------------------------------------- | -------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **ã‚·ãƒŠãƒªã‚ª1** | å…¨ã¦åŒã˜Key + maxMessages=1                                          | **ç›´åˆ—å‡¦ç†**   | âœ… å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ACKå®Œäº†ã¾ã§æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ–ãƒ­ãƒƒã‚¯                                                                  |
| **ã‚·ãƒŠãƒªã‚ª2** | å…¨ã¦ç•°ãªã‚‹Key + maxMessages=1                                        | **3ä¸¦åˆ—å‡¦ç†**  | âœ… OrderingKeyæŒ‡å®šãªã—ã¨åŒæ§˜ã®ä¸¦åˆ—å‡¦ç†                                                                                  |
| **ã‚·ãƒŠãƒªã‚ª3** | 2ã¤ã®Keyã‚°ãƒ«ãƒ¼ãƒ— + maxMessages=1<br/>(1-5ç•ªç›®: Key1, 6-15ç•ªç›®: Key2) | **2ä¸¦åˆ—å‡¦ç†**  | âœ… å„Keyã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ACKé †åºä¿è¨¼                                                                                       |
| **ã‚·ãƒŠãƒªã‚ª4** | å…¨ã¦åŒã˜Key + maxMessages=3                                          | **ãƒãƒƒãƒå‡¦ç†** | ğŸ†• å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ACKå®Œäº†ã¾ã§æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ–ãƒ­ãƒƒã‚¯ã€‚ãŸã ã—ã€åŒä¸€Subscriberå†…ã§ã¯åŒã˜OrderingKeyã‚’è¤‡æ•°åŒæ™‚pullå¯èƒ½ã€‚ |

### ğŸ¯ é‡è¦ãªç™ºè¦‹

**OrderedKeyã¯ã€ŒSubscriberå˜ä½ã§ã®æ’ä»–åˆ¶å¾¡ã€ã‚’è¡Œã†**

#### ğŸ” è©³ç´°ãªæŒ™å‹•åˆ†æ

**1. åŒä¸€Subscriberå†…ã§ã®ãƒãƒƒãƒå‡¦ç†**
- âœ… **maxMessages=3**: åŒã˜OrderedKeyã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¤‡æ•°åŒæ™‚ã«pullå¯èƒ½
- âœ… **é †æ¬¡å‡¦ç†**: pullã—ãŸè¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é †ç•ªã«å‡¦ç†
- âœ… **ãƒãƒƒãƒACK**: å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†å®Œäº†å¾Œã«ã¾ã¨ã‚ã¦ACK

**2. åŒã˜OrderingKeyã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã™ã‚‹Subscriberé–“ã®æ’ä»–åˆ¶å¾¡**
- âœ… **å³å¯†ãªæ’ä»–**: ã‚ã‚‹SubscriberAãŒè¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’pullã—ã¦ã„ã‚‹é–“ã€ä»–ã®Subscriberã¯pullä¸å¯
- âœ… **ACKå¾…ã¡**: SubscriberAãŒå…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ACKã™ã‚‹ã¾ã§ã€ä»–ã®Subscriberã¯å¾…æ©Ÿ
- âœ… **é †åºä¿è¨¼**: Subscriberé–“ã§ã¯å³å¯†ãªé †åºã‚’ä¿è¨¼

## æœŸå¾…ã•ã‚Œã‚‹çµæœï¼ˆæ¤œè¨¼å‰ã®ä»®èª¬ï¼‰

### ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼ˆå³å¯†ãªé †åºä¿è¨¼ã®å ´åˆï¼‰- âœ… æ¤œè¨¼ã§ç¢ºèª
```
[Subscriber-1] Pulled: Message A at 10:00:00
[Subscriber-2] Waiting... (Message Bã¯pullä¸å¯)
[Subscriber-3] Waiting... (Message Bã¯pullä¸å¯)
[Subscriber-1] ACKing: Message A at 10:00:05
[Subscriber-2] Pulled: Message B at 10:00:05
[Subscriber-2] ACKing: Message B at 10:00:10
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼ˆé…ä¿¡é †åºã®ã¿ä¿è¨¼ã®å ´åˆï¼‰- âŒ æ¤œè¨¼ã§å¦å®š
```
[Subscriber-1] Pulled: Message A at 10:00:00
[Subscriber-2] Pulled: Message B at 10:00:00  # Aã®ACKå‰ã§ã‚‚å¯èƒ½
[Subscriber-1] ACKing: Message A at 10:00:05
[Subscriber-2] ACKing: Message B at 10:00:05
```
